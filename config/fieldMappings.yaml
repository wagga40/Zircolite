# =============================================================================
# Zircolite Field Mappings Configuration
# =============================================================================
# This file defines how log fields are processed, mapped, and transformed.
# Supports both JSON (.json) and YAML (.yaml, .yml) formats.
#
# Sections:
#   - exclusions: Fields to exclude from processing
#   - useless: Values to filter out (null, empty strings)
#   - mappings: Rename nested/complex field names to simpler ones
#   - alias: Create additional field names with same values
#   - split: Split field values into multiple fields
#   - transforms: Apply Python code to transform field values
# =============================================================================

# -----------------------------------------------------------------------------
# FIELD EXCLUSIONS
# -----------------------------------------------------------------------------
# List of substrings - any field containing these strings will be excluded.
# Useful for removing namespace prefixes or unwanted metadata.
exclusions:
  - xmlns  # XML namespace attributes

# -----------------------------------------------------------------------------
# VALUE EXCLUSIONS (USELESS VALUES)
# -----------------------------------------------------------------------------
# Values that should be filtered out from the final output.
# Fields with these values will be removed from events.
useless:
  - null   # Null values
  - ""     # Empty strings

# -----------------------------------------------------------------------------
# FIELD MAPPINGS
# -----------------------------------------------------------------------------
# Maps long/nested field names to shorter, standardized names.
# Format: "Original.Nested.Field.Name": "SimplifiedName"
#
# These mappings are essential for:
#   - Normalizing EVTX XML structure to flat fields
#   - Making field names compatible with SIGMA rules
#   - Simplifying queries and analysis
# -----------------------------------------------------------------------------
mappings:
  Event.EventData.UserData: UserData
  Event.System.Provider.#attributes.Guid: Guid
  Event.EventData.ContextInfo: ContextInfo
  Event.System.Execution.#attributes.ProcessID: ProcessID
  Event.System.Execution.#attributes.ThreadID: ThreadID
  Event.System.EventID: EventID
  Event.System.EventID.#text: EventID  # Alternative format
  Event.System.Channel: Channel
  Event.System.Computer: Computer
  Event.System.Correlation: Correlation
  Event.System.Correlation.#attributes.ActivityID: ActivityID
  Event.System.EventID.#attributes.Qualifiers: Qualifiers
  Event.System.EventRecordID: EventRecordID
  Event.System.Keywords: Keywords
  Event.System.Level: Level
  Event.System.Opcode: Opcode
  Event.System.Task: Task
  Event.System.Version: Version
  Event.System.Provider.#attributes.EventSourceName: EventSourceName
  Event.System.Provider.#attributes.Name: Provider_Name
  Event.System.Security: Security
  Event.System.Security.#attributes.UserID: UserID
  Event.System.TimeCreated.#attributes.SystemTime: SystemTime
  Event.EventData.AccessList: AccessList
  Event.EventData.AccessMask: AccessMask
  Event.EventData.Accesses: Accesses
  Event.EventData.AccountDomain: AccountDomain
  Event.EventData.AccountExpires: AccountExpires
  Event.EventData.AccountName: AccountName
  Event.EventData.AuthenticationPackageName: AuthenticationPackageName
  Event.EventData.FailureCode: FailureCode
  Event.EventData.FailureReason: FailureReason
  Event.EventData.KeyLength: KeyLength
  Event.EventData.LmPackageName: LmPackageName
  Event.EventData.LogonGuid: LogonGuid
  Event.EventData.LogonHours: LogonHours
  Event.EventData.LogonId: LogonId
  Event.EventData.LogonProcessName: LogonProcessName
  Event.EventData.LogonType: LogonType
  Event.EventData.PrivilegeList: PrivilegeList
  Event.EventData.SecurityPackageName: SecurityPackageName
  Event.EventData.TicketEncryptionType: TicketEncryptionType
  Event.EventData.TicketOptions: TicketOptions
  Event.EventData.TokenElevationType: TokenElevationType
  Event.EventData.TransmittedServices: TransmittedServices
  Event.EventData.CallTrace: CallTrace
  Event.EventData.CommandLine: CommandLine
  Event.EventData.CurrentDirectory: CurrentDirectory
  Event.EventData.Image: Image
  Event.EventData.ImageLoaded: ImageLoaded
  Event.EventData.ImagePath: ImagePath
  Event.EventData.IntegrityLevel: IntegrityLevel
  Event.EventData.NewProcessId: NewProcessId
  Event.EventData.NewProcessName: NewProcessName
  Event.EventData.OriginalFileName: OriginalFileName
  Event.EventData.ParentCommandLine: ParentCommandLine
  Event.EventData.ParentImage: ParentImage
  Event.EventData.ParentProcessGuid: ParentProcessGuid
  Event.EventData.ParentProcessId: ParentProcessId
  Event.EventData.ParentIntegrityLevel: ParentIntegrityLevel
  Event.EventData.ParentUser: ParentUser
  Event.EventData.ProcessCommandLine: ProcessCommandLine
  Event.EventData.ProcessGuid: ProcessGuid
  Event.EventData.ProcessId: ProcessId
  Event.EventData.ProcessName: ProcessName
  Event.EventData.SourceImage: SourceImage
  Event.EventData.SourceProcessGuid: SourceProcessGuid
  Event.EventData.SourceProcessId: SourceProcessId
  Event.EventData.StartAddress: StartAddress
  Event.EventData.StartFunction: StartFunction
  Event.EventData.StartModule: StartModule
  Event.EventData.TargetImage: TargetImage
  Event.EventData.TargetProcessAddress: TargetProcessAddress
  Event.EventData.TargetProcessGuid: TargetProcessGuid
  Event.EventData.TargetProcessId: TargetProcessId
  Event.EventData.TerminalSessionId: TerminalSessionId
  Event.EventData.Address: Address
  Event.EventData.AddressLength: AddressLength
  Event.EventData.Application: Application
  Event.EventData.DestinationAddress: DestinationAddress
  Event.EventData.DestinationHostname: DestinationHostname
  Event.EventData.DestinationIp: DestinationIp
  Event.EventData.DestinationIsIpv6: DestinationIsIpv6
  Event.EventData.DestinationPort: DestinationPort
  Event.EventData.DestinationPortName: DestinationPortName
  Event.EventData.DestPort: DestPort
  Event.EventData.Initiated: Initiated
  Event.EventData.IpAddress: IpAddress
  Event.EventData.IpPort: IpPort
  Event.EventData.LayerRTID: LayerRTID
  Event.EventData.Protocol: Protocol
  Event.EventData.QueryName: QueryName
  Event.EventData.QueryResults: QueryResults
  Event.EventData.QueryStatus: QueryStatus
  Event.EventData.SourceAddress: SourceAddress
  Event.EventData.SourceHostname: SourceHostname
  Event.EventData.SourceIp: SourceIp
  Event.EventData.SourceNetworkAddress: SourceNetworkAddress
  Event.EventData.SourceIsIpv6: SourceIsIpv6
  Event.EventData.SourcePort: SourcePort
  Event.EventData.SourcePortName: SourcePortName
  Event.EventData.CreationUtcTime: CreationUtcTime
  Event.EventData.Detail: Detail
  Event.EventData.Details: Details
  Event.EventData.HandleId: HandleId
  Event.EventData.Hash: Hash
  Event.EventData.Hashes: Hashes
  Event.EventData.HiveName: HiveName
  Event.EventData.NewName: NewName
  Event.EventData.ObjectName: ObjectName
  Event.EventData.ObjectServer: ObjectServer
  Event.EventData.ObjectType: ObjectType
  Event.EventData.ObjectValueName: ObjectValueName
  Event.EventData.RelativeTargetName: RelativeTargetName
  Event.EventData.ShareLocalPath: ShareLocalPath
  Event.EventData.ShareName: ShareName
  Event.EventData.TargetFilename: TargetFileName  # Note: normalized to TargetFileName
  Event.EventData.TargetObject: TargetObject
  Event.EventData.AllowedToDelegateTo: AllowedToDelegateTo
  Event.EventData.DisplayName: DisplayName
  Event.EventData.Group: Group
  Event.EventData.GroupDomain: GroupDomain
  Event.EventData.GroupName: GroupName
  Event.EventData.GroupSid: GroupSid
  Event.EventData.HomeDirectory: HomeDirectory
  Event.EventData.HomePath: HomePath
  Event.EventData.NewUacValue: NewUacValue
  Event.EventData.OldUacValue: OldUacValue
  Event.EventData.PasswordLastSet: PasswordLastSet
  Event.EventData.PrimaryGroupId: PrimaryGroupId
  Event.EventData.ProfilePath: ProfilePath
  Event.EventData.SamAccountName: SAMAccountName
  Event.EventData.ScriptPath: ScriptPath
  Event.EventData.ServicePrincipalNames: ServicePrincipalNames
  Event.EventData.SidHistory: SidHistory
  Event.EventData.SubjectDomainName: SubjectDomainName
  Event.EventData.SubjectLogonId: SubjectLogonId
  Event.EventData.SubjectUserName: SubjectUserName
  Event.EventData.SubjectUserSid: SubjectUserSid
  Event.EventData.TargetDomainName: TargetDomainName
  Event.EventData.TargetInfo: TargetInfo
  Event.EventData.TargetLogonGuid: TargetLogonGuid
  Event.EventData.TargetLogonId: TargetLogonId
  Event.EventData.TargetServerName: TargetServerName
  Event.EventData.TargetSid: TargetSid
  Event.EventData.TargetUserName: TargetUserName
  Event.EventData.TargetUserSid: TargetUserSid
  Event.EventData.User: User
  Event.EventData.UserAccountControl: UserAccountControl
  Event.EventData.UserParameters: UserParameters
  Event.EventData.UserPrincipalName: UserPrincipalName
  Event.EventData.UserSid: UserSid
  Event.EventData.UserWorkstations: UserWorkstations
  Event.EventData.Service: Service
  Event.EventData.ServiceName: ServiceName
  Event.EventData.ServiceType: ServiceType
  Event.EventData.ServiceVersion: ServiceVersion
  Event.EventData.StartTime: StartTime
  Event.EventData.StartType: StartType
  Event.EventData.State: State
  Event.EventData.Status: Status
  Event.EventData.StopTime: StopTime
  Event.EventData.TaskContent: TaskContent
  Event.EventData.TaskContentNew: TaskContentNew
  Event.EventData.TaskName: TaskName
  Event.EventData.HostApplication: HostApplication
  Event.EventData.HostName: HostName
  Event.EventData.HostVersion: HostVersion
  Event.EventData.Payload: Payload
  Event.EventData.ScriptBlockText: ScriptBlockText
  Event.EventData.AttributeLDAPDisplayName: AttributeLDAPDisplayName
  Event.EventData.AttributeValue: AttributeValue
  Event.EventData.DCName: DCName
  Event.EventData.LDAPDisplayName: LDAPDisplayName
  Event.EventData.ObjectClass: ObjectClass
  Event.EventData.OperationType: OperationType
  Event.EventData.Properties: Properties
  Event.EventData.AuditPolicyChanges: AuditPolicyChanges
  Event.EventData.AuditSourceName: AuditSourceName
  Event.EventData.NotificationPackageName: NotificationPackageName
  Event.EventData.DeviceClassName: DeviceClassName
  Event.EventData.DeviceDescription: DeviceDescription
  Event.EventData.DeviceName: DeviceName
  Event.EventData.DeviceNameLength: DeviceNameLength
  Event.EventData.DeviceTime: DeviceTime
  Event.EventData.DeviceVersionMajor: DeviceVersionMajor
  Event.EventData.DeviceVersionMinor: DeviceVersionMinor
  Event.EventData.DetectionSource: DetectionSource
  Event.EventData.EngineVersion: EngineVersion
  Event.EventData.PuaCount: PuaCount
  Event.EventData.PuaPolicyId: PuaPolicyId
  Event.EventData.Signature: Signature
  Event.EventData.SignatureStatus: SignatureStatus
  Event.EventData.Signed: Signed
  Event.EventData.Binary: Binary
  Event.EventData.BootMode: BootMode
  Event.EventData.BuildVersion: BuildVersion
  Event.EventData.Company: Company
  Event.EventData.Context: Context
  Event.EventData.Description: Description
  Event.EventData.ErrorCode: ErrorCode
  Event.EventData.ErrorDescription: ErrorDescription
  Event.EventData.ErrorMessage: ErrorMessage
  Event.EventData.EventSourceId: EventSourceId
  Event.EventData.EventType: EventType
  Event.EventData.ExtraInfo: ExtraInfo
  Event.EventData.FileVersion: FileVersion
  Event.EventData.FilterHostProcessID: FilterHostProcessID
  Event.EventData.FinalStatus: FinalStatus
  Event.EventData.GrantedAccess: GrantedAccess
  Event.EventData.IdleStateCount: IdleStateCount
  Event.EventData.MajorVersion: MajorVersion
  Event.EventData.Data.#text: Message
  Event.EventData.MinorVersion: MinorVersion
  Event.EventData.NewState: NewState
  Event.EventData.NewThreadId: NewThreadId
  Event.EventData.NewTime: NewTime
  Event.EventData.NewValue: NewValue
  Event.EventData.Number: Number
  Event.EventData.NumberOfGroupPolicyObjects: NumberOfGroupPolicyObjects
  Event.EventData.OldTime: OldTime
  Event.EventData.PackageName: PackageName
  Event.EventData.PerfStateCount: PerfStateCount
  Event.EventData.PreviousTime: PreviousTime
  Event.EventData.ProcessingMode: ProcessingMode
  Event.EventData.ProcessingTimeInMilliseconds: ProcessingTimeInMilliseconds
  Event.EventData.Product: Product
  Event.EventData.ProtocolHostProcessID: ProtocolHostProcessID
  Event.EventData.Publisher: Publisher
  Event.EventData.QfeVersion: QfeVersion
  Event.EventData.ResourceManager: ResourceManager
  Event.EventData.RetryMinutes: RetryMinutes
  Event.EventData.RuleName: RuleName
  Event.EventData.SchemaVersion: SchemaVersion
  Event.EventData.ServerID: ServerID
  Event.EventData.ServerURL: ServerURL
  Event.EventData.ShutdownActionType: ShutdownActionType
  Event.EventData.ShutdownEventCode: ShutdownEventCode
  Event.EventData.ShutdownReason: ShutdownReason
  Event.EventData.SubStatus: SubStatus
  Event.EventData.ThrottleStateCount: ThrottleStateCount
  Event.EventData.TimeSource: TimeSource
  Event.EventData.TransactionId: TransactionId
  Event.EventData.TSId: TSId
  Event.EventData.UtcTime: UtcTime
  Event.EventData.Version: Version
  Event.EventData.Workstation: Workstation
  Event.EventData.WorkstationName: WorkstationName
  Event.EventData.AddonName: AddonName
  Event.EventData.ExtensionId: ExtensionId
  Event.EventData.ExtensionName: ExtensionName
  Event.EventData.CallingProcessName: CallingProcessName
  Event.EventData.PipeName: PipeName
  Event.EventData.updateGuid: updateGuid
  Event.EventData.updateRevisionNumber: updateRevisionNumber
  Event.EventData.updateTitle: updateTitle

# -----------------------------------------------------------------------------
# FIELD ALIASES
# -----------------------------------------------------------------------------
# Create additional field names that contain the same value as the original.
# Useful for compatibility with different SIGMA rule naming conventions.
# Format: "OriginalField": "AliasField"
#
# Example:
#   CommandLine: cmd
#   Image: ProcessPath
# -----------------------------------------------------------------------------
alias: {}

# -----------------------------------------------------------------------------
# FIELD SPLITTING
# -----------------------------------------------------------------------------
# Split a single field value into multiple fields based on separators.
# Commonly used for hash fields that contain multiple hash types.
#
# Format:
#   FieldName:
#     separator: ","     # Character(s) separating key-value pairs
#     equal: "="         # Character(s) separating key from value
#
# Example: "MD5=abc123,SHA256=def456" becomes:
#   MD5: abc123
#   SHA256: def456
# -----------------------------------------------------------------------------
split:
  Hash:
    separator: ","
    equal: "="
  Hashes:
    separator: ","
    equal: "="
  ConfigurationFileHash:
    separator: ","
    equal: "="

# -----------------------------------------------------------------------------
# TRANSFORMS
# -----------------------------------------------------------------------------
# Enable/disable the transform engine globally.
# When disabled, all transform definitions are ignored.
# -----------------------------------------------------------------------------
transforms_enabled: true

# -----------------------------------------------------------------------------
# TRANSFORM DEFINITIONS
# -----------------------------------------------------------------------------
# Apply Python code to transform field values.
# Transforms can either modify the original value or create an alias field.
#
# Transform structure:
#   FieldName:
#     - info: "Description of the transform"
#       type: "python"
#       code: |
#         def transform(param):
#             # Your transformation logic
#             return transformed_value
#       alias: true/false        # If true, creates new field; if false, modifies original
#       alias_name: "NewField"   # Name for alias field (required if alias: true)
#       source_condition:        # List of input types where this transform applies
#         - evtx_input
#         - json_input
#         - json_array_input
#         - auditd_input
#         - sysmon_linux_input
#         - xml_input
#         - csv_input
#         - evtxtract_input
#         - db_input
#       enabled: true/false      # Enable/disable this specific transform
# -----------------------------------------------------------------------------
transforms:
  # -------------------------
  # Auditd Transforms
  # -------------------------
  # Convert hex-encoded proctitle to ASCII (Auditd logs)
  proctitle:
    - info: "Proctitle HEX to ASCII"
      type: python
      code: |
        def transform(param):
          return bytes.fromhex(param).decode('ascii').replace('\x00',' ')
      alias: false
      alias_name: ""
      source_condition:
        - auditd_input
      enabled: true

  # Convert hex-encoded cmd to ASCII (Auditd logs)
  cmd:
    - info: "Cmd HEX to ASCII"
      type: python
      code: |
        def transform(param):
          return bytes.fromhex(param).decode('ascii').replace('\x00',' ')
      alias: false
      alias_name: ""
      source_condition:
        - auditd_input
      enabled: true

  # -------------------------
  # CommandLine Transforms
  # -------------------------
  CommandLine:
    # Base64 decoding for encoded commands
    - info: "Base64 decoded CommandLine"
      type: python
      code: |
        def transform(param):
            decoded_values = []
            concatenated_result = ''
            data = param

            base64_pattern = r'(?:[A-Za-z0-9+/]{4}){2,}(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?'
            matches = re.findall(base64_pattern, data)
            for match in matches:
                decoded = base64.b64decode(match)
                encoding = chardet.detect(decoded)['encoding']
                if encoding and encoding in ['utf-8', 'ascii', 'utf-16le', 'ISO-8859-1']:
                    decoded = decoded.decode(encoding)
                    decoded = decoded.strip()
                    if decoded.isprintable() and len(decoded) > 10 :
                        decoded_values.append(decoded)
            
            concatenated_result = '|'.join(decoded_values)
            return concatenated_result
      alias: true
      alias_name: "CommandLine_b64decoded"
      source_condition:
        - evtx_input
        - json_array_input
        - json_input
        - evtxtract_input
        - db_input
      enabled: false  # Disabled by default - enable for base64 analysis

    # Credential extraction from command lines
    # Regex patterns by Practical Security Analytics
    # https://practicalsecurityanalytics.com/extracting-credentials-from-windows-logs/
    - info: "CommandLine credentials extraction"
      type: python
      code: |
        def transform(param):
            import re
            regex_patterns = [
                r'net.+user\s+(?P<username>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+))\s+(?P<password>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+))',
                r'net.+use\s+(?P<share>\\\\\S+)\s+/USER:(?P<username>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+))\s+(?P<password>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+))',
                r'schtasks.+/U\s+(?P<username>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+)).+/P\s+(?P<password>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+))',
                r'wmic.+/user:\s*(?P<username>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+)).+/password:\s*(?P<password>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+))',
                r'psexec.+-u\s+(?P<username>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+)).+-p\s+(?P<password>(?:"((?:\\.|[^"\\])*)")|(?:[^\s"]+))'
            ]

            matches = []
            
            for pattern in regex_patterns:
                found = re.findall(pattern, param)
                if len(found) > 0:
                    for match in list(found[0]):
                        if len(match) > 0:  
                            matches.append(match) 

            concatenated_result = '|'.join(matches)
            if concatenated_result == None:
                return ''
            return concatenated_result
      alias: true
      alias_name: "CommandLine_Extracted_Creds"
      source_condition:
        - evtx_input
        - json_array_input
        - json_input
        - evtxtract_input
        - db_input
      enabled: false  # Disabled by default - enable for credential hunting

  # -------------------------
  # Payload Transforms
  # -------------------------
  Payload:
    - info: "Base64 decoded Payload"
      type: python
      code: |
        def transform(param):
            decoded_values = []
            concatenated_result = ''
            data = param

            base64_pattern = r'(?:[A-Za-z0-9+/]{4}){2,}(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?'
            matches = re.findall(base64_pattern, data)
            for match in matches:
                decoded = base64.b64decode(match)
                encoding = chardet.detect(decoded)['encoding']
                if encoding and encoding in ['utf-8', 'ascii', 'utf-16le', 'ISO-8859-1']:
                    decoded = decoded.decode(encoding)
                    decoded = decoded.strip()
                    if decoded.isprintable() and len(decoded) > 10 :
                        decoded_values.append(decoded)
            
            concatenated_result = '|'.join(decoded_values)
            return concatenated_result
      alias: true
      alias_name: "Payload_b64decoded"
      source_condition:
        - evtx_input
        - json_array_input
        - json_input
        - evtxtract_input
        - db_input
      enabled: false  # Disabled by default - enable for payload analysis

  # -------------------------
  # ServiceFileName Transforms
  # -------------------------
  ServiceFileName:
    - info: "Base64 decoded ServiceFileName"
      type: python
      code: |
        def transform(param):
            decoded_values = []
            concatenated_result = ''
            data = param

            base64_pattern = r'(?:[A-Za-z0-9+/]{4}){2,}(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?'
            matches = re.findall(base64_pattern, data)
            for match in matches:
                decoded = base64.b64decode(match)
                encoding = chardet.detect(decoded)['encoding']
                if encoding and encoding in ['utf-8', 'ascii', 'utf-16le', 'ISO-8859-1']:
                    decoded = decoded.decode(encoding)
                    decoded = decoded.strip()
                    if decoded.isprintable() and len(decoded) > 10 :
                        decoded_values.append(decoded)
            
            concatenated_result = '|'.join(decoded_values)
            return concatenated_result
      alias: true
      alias_name: "ServiceFileName_b64decoded"
      source_condition:
        - evtx_input
        - json_array_input
        - json_input
        - evtxtract_input
        - db_input
      enabled: false  # Disabled by default - enable for service analysis
